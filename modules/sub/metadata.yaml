# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: blueprints.cloud.google.com/v1alpha1
kind: BlueprintMetadata
metadata:
  name: terraform-google-pubsub-sub
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  info:
    title: terraform-google-pubsub
    source:
      repo: https://github.com/terraform-google-modules/terraform-google-pubsub
      sourceType: git
      dir: /modules/sub
    version: 8.0.1
    actuationTool:
      flavor: Terraform
      version: ">= 1.3"
    description: {}
  content:
    examples:
      - name: bigquery
        location: examples/bigquery
      - name: bigquery-separate-pub-sub
        location: examples/bigquery-separate-pub-sub
      - name: cloud_storage
        location: examples/cloud_storage
      - name: cloud_storage-separate-pub-sub
        location: examples/cloud_storage-separate-pub-sub
      - name: kms
        location: examples/kms
      - name: simple
        location: examples/simple
      - name: simple-separate-pub-sub
        location: examples/simple-separate-pub-sub
      - name: subscriptions_only
        location: examples/subscriptions_only
  interfaces:
    variables:
      - name: project_id
        description: The project ID to manage the Pub/Sub resources.
        varType: string
        required: true
      - name: topic
        description: The Pub/Sub topic name.
        varType: string
        required: true
      - name: push_subscriptions
        description: The list of the push subscriptions.
        varType: |-
          list(object({
              name                       = string,
              ack_deadline_seconds       = optional(number),
              push_endpoint              = optional(string),
              x-goog-version             = optional(string),
              oidc_service_account_email = optional(string),
              audience                   = optional(string),
              expiration_policy          = optional(string),
              dead_letter_topic          = optional(string),
              retain_acked_messages      = optional(bool),
              message_retention_duration = optional(string),
              max_delivery_attempts      = optional(number),
              maximum_backoff            = optional(string),
              minimum_backoff            = optional(string),
              filter                     = optional(string),
              enable_message_ordering    = optional(bool),
            }))
        defaultValue: []
      - name: pull_subscriptions
        description: The list of the pull subscriptions.
        varType: |-
          list(object({
              name                         = string,
              ack_deadline_seconds         = optional(number),
              expiration_policy            = optional(string),
              dead_letter_topic            = optional(string),
              max_delivery_attempts        = optional(number),
              retain_acked_messages        = optional(bool),
              message_retention_duration   = optional(string),
              maximum_backoff              = optional(string),
              minimum_backoff              = optional(string),
              filter                       = optional(string),
              enable_message_ordering      = optional(bool),
              service_account              = optional(string),
              enable_exactly_once_delivery = optional(bool),
            }))
        defaultValue: []
      - name: bigquery_subscriptions
        description: The list of the Bigquery push subscriptions.
        varType: |-
          list(object({
              name                       = string,
              table                      = string,
              use_topic_schema           = optional(bool),
              use_table_schema           = optional(bool),
              write_metadata             = optional(bool),
              drop_unknown_fields        = optional(bool),
              ack_deadline_seconds       = optional(number),
              retain_acked_messages      = optional(bool),
              message_retention_duration = optional(string),
              enable_message_ordering    = optional(bool),
              expiration_policy          = optional(string),
              filter                     = optional(string),
              dead_letter_topic          = optional(string),
              maximum_backoff            = optional(string),
              minimum_backoff            = optional(string)
            }))
        defaultValue: []
      - name: cloud_storage_subscriptions
        description: The list of the Cloud Storage push subscriptions.
        varType: |-
          list(object({
              name                       = string,
              bucket                     = string,
              filename_prefix            = optional(string),
              filename_suffix            = optional(string),
              filename_datetime_format   = optional(string),
              max_duration               = optional(string),
              max_bytes                  = optional(string),
              max_messages               = optional(string),
              output_format              = optional(string),
              write_metadata             = optional(bool),
              use_topic_schema           = optional(bool),
              ack_deadline_seconds       = optional(number),
              retain_acked_messages      = optional(bool),
              message_retention_duration = optional(string),
              enable_message_ordering    = optional(bool),
              expiration_policy          = optional(string),
              filter                     = optional(string),
              dead_letter_topic          = optional(string),
              maximum_backoff            = optional(string),
              minimum_backoff            = optional(string)
            }))
        defaultValue: []
      - name: subscription_labels
        description: A map of labels to assign to every Pub/Sub subscription.
        varType: map(string)
        defaultValue: {}
      - name: grant_bigquery_project_roles
        description: Specify true if you want to add bigquery.metadataViewer and bigquery.dataEditor roles to the default Pub/Sub SA.
        varType: bool
        defaultValue: true
      - name: grant_token_creator
        description: Specify true if you want to add token creator role to the default Pub/Sub SA.
        varType: bool
        defaultValue: true
    outputs:
      - name: subscription_names
        description: The name list of Pub/Sub subscriptions
      - name: subscription_paths
        description: The path list of Pub/Sub subscriptions
  requirements:
    roles:
      - level: Project
        roles:
          - roles/pubsub.admin
          - roles/resourcemanager.projectIamAdmin
          - roles/bigquery.admin
          - roles/storage.admin
    services:
      - cloudresourcemanager.googleapis.com
      - pubsub.googleapis.com
      - serviceusage.googleapis.com
      - bigquery.googleapis.com
      - storage.googleapis.com
    providerVersions:
      - source: hashicorp/google
        version: ">= 6.2, < 7"
